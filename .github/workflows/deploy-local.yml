name: Deploy Local (Docker Compose)

on:
  workflow_dispatch:

jobs:
  build-and-push-local:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build backend image
        run: |
          cd backend
          docker build -t propflow-backend:latest .

      - name: Build dashboard image
        run: |
          docker build -t propflow-dashboard:latest \
            -f frontend/apps/valuer-dashboard/Dockerfile .

      - name: Save images as artifacts
        run: |
          docker save propflow-backend:latest > propflow-backend.tar
          docker save propflow-dashboard:latest > propflow-dashboard.tar

      - name: Upload backend image
        uses: actions/upload-artifact@v4
        with:
          name: propflow-backend-image
          path: propflow-backend.tar
          retention-days: 7

      - name: Upload dashboard image
        uses: actions/upload-artifact@v4
        with:
          name: propflow-dashboard-image
          path: propflow-dashboard.tar
          retention-days: 7

      - name: Generate docker-compose.prod.yml
        run: |
          cat > docker-compose.prod.yml << 'EOF'
          version: '3.8'

          services:
            db:
              image: postgres:15-alpine
              environment:
                POSTGRES_USER: propflow
                POSTGRES_PASSWORD: ${DB_PASSWORD:-propflow123}
                POSTGRES_DB: propflow
              volumes:
                - postgres_data:/var/lib/postgresql/data
              ports:
                - "5432:5432"
              healthcheck:
                test: ["CMD-SHELL", "pg_isready -U propflow"]
                interval: 5s
                timeout: 5s
                retries: 5

            redis:
              image: redis:7-alpine
              ports:
                - "6379:6379"
              volumes:
                - redis_data:/data

            backend:
              image: propflow-backend:latest
              environment:
                DATABASE_URL: postgresql://propflow:${DB_PASSWORD:-propflow123}@db:5432/propflow
                REDIS_URL: redis://redis:6379/0
                SECRET_KEY: ${SECRET_KEY:-your-secret-key-change-in-production}
              ports:
                - "8000:8000"
              depends_on:
                db:
                  condition: service_healthy
                redis:
                  condition: service_started

            dashboard:
              image: propflow-dashboard:latest
              environment:
                NEXT_PUBLIC_API_URL: http://localhost:8000/api/v1
              ports:
                - "3000:3000"
              depends_on:
                - backend

          volumes:
            postgres_data:
            redis_data:
          EOF

      - name: Upload docker-compose file
        uses: actions/upload-artifact@v4
        with:
          name: deployment-bundle
          path: docker-compose.prod.yml
          retention-days: 7

      - name: Summary
        run: |
          echo "## Build Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Images built successfully:" >> $GITHUB_STEP_SUMMARY
          echo "- propflow-backend:latest" >> $GITHUB_STEP_SUMMARY
          echo "- propflow-dashboard:latest" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "To deploy locally:" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "docker load -i propflow-backend.tar" >> $GITHUB_STEP_SUMMARY
          echo "docker load -i propflow-dashboard.tar" >> $GITHUB_STEP_SUMMARY
          echo "docker-compose -f docker-compose.prod.yml up -d" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  build-mobile-local:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v3
        with:
          version: 8

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install

      - name: Prebuild Expo app
        run: |
          cd frontend/apps/customer-app
          npx expo prebuild --platform android --clean

      - name: Build Android APK locally
        run: |
          cd frontend/apps/customer-app/android
          ./gradlew assembleRelease 2>&1 | tail -30

      - name: Find and upload APK
        uses: actions/upload-artifact@v4
        with:
          name: customer-app-apk
          path: frontend/apps/customer-app/android/app/build/outputs/apk/release/*.apk
          retention-days: 7
          if-no-files-found: warn

      - name: Summary
        run: |
          echo "## Mobile Build Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "APK built successfully (if found)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Download the APK from the artifacts section." >> $GITHUB_STEP_SUMMARY

  run-migrations-local:
    runs-on: ubuntu-latest
    needs: [build-and-push-local]

    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: propflow
          POSTGRES_PASSWORD: propflow123
          POSTGRES_DB: propflow
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          cd backend
          pip install -r requirements.txt

      - name: Run Alembic migrations
        env:
          DATABASE_URL: postgresql://propflow:propflow123@localhost:5432/propflow
        run: |
          cd backend
          alembic upgrade head

      - name: Verify migrations
        env:
          DATABASE_URL: postgresql://propflow:propflow123@localhost:5432/propflow
        run: |
          cd backend
          alembic current

      - name: Summary
        run: |
          echo "## Migrations Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Database migrations ran successfully." >> $GITHUB_STEP_SUMMARY
